\section{绪论}

\subsection{研究背景及意义}

近年来，人工智能、云计算、等领域快速发展，
尤其是大规模预训练模型的发展取得了显著进展。
面对急剧增加的计算需求，
传统的中央处理单元（CPU）和图形处理单元（GPU）在面对复杂计算任务时，
逐渐暴露出功耗高、延迟大等问题。
FPGA作为一种可重构的硬件加速器，
以其独特的优势成为高性能计算领域的重要解决方案。
FPGA具有高并行处理能力、低延迟、可重构性和低功耗等特点，
能够在多种应用场景中提供卓越的性能，
在人工智能\cite{zeng2024flightllm}、数据中心、通信网络等领域展现出了巨大的应用价值，
吸引了越来越多的研究人员和开发者投身于FPGA相关技术的研究和应用开发。

然而，传统的FPGA开发过程复杂且耗时，
需要深入掌握硬件描述语言（HDL）如VHDL或Verilog，
也需要熟悉硬件理论并适应HDL编程的复杂性和较低的抽象层次，
这种开发模式对于软件工程师和非硬件背景的开发者来说门槛较高，
限制了FPGA的普及与应用。
为了简化FPGA的开发过程，
高层综合（High-Level Synthesis，HLS）技术\cite{hls}应运而生。
HLS技术通过将高级编程语言（如C、C++、SystemC）转化为硬件描述语言代码，
它是一种使软件开发人员能够利用硬件加速器的工具，
能够降低硬件设计的门槛，
使得开发FPGA变得更加高效和便捷。

Python是一种简洁且功能强大的语言，
拥有丰富的第三方库和工具，
如NumPy、SciPy、Pandas等，
可以满足各种复杂计算和数据处理需求。
Python如今已广泛应用于许多领域，
如人工智能、数据分析、科学计算。

然而，Python有一个广为人知的问题，即性能瓶颈。
性能瓶颈主要来源于Python的解释型特性、全局解释器锁、动态类型系统以及垃圾回收机制。
针对这个问题，有许多现有的解决方案可以提高Python的性能和并发能力，
如JIT\cite{rpython}\cite{pypy1}\cite{izawa2022threaded}\cite{pypy2}、
高性能计算库\cite{harris2020array}、
Cython\cite{cython}等。
然而这些计算加速方案主要依赖于软件层面的优化，
无法突破通用硬件架构的限制，
受限于CPU并行处理能力和内存带宽。
相比之下，FPGA可以实现真正的并行处理，
数据处理的延迟也非常低，
并且可以随需求的变化重新配置硬件，
适应不同的算法和应用场景，
而无需对硬件进行大规模的改动。
Python的高层综合解决方案，
能够融合Python与FPGA硬件加速的优势，
为Python高性能计算提供新的可能性。

然而，学术界和工业界对于Python在FPGA开发领域的研究和实践相对较少，
尤其是在高层综合方面。
这是因为Python代码抽象层级较高，
难以直接映射到硬件级别的细节。

鉴于此，研究面向FPGA的Python编译方法，
将Python引入高层综合生态，
具有重要意义。
这可以为基于Python的许多复杂且耗时的计算任务提供可观的性能提升，
显著减少计算时间和能耗，
同时也能降低软件开发人员利用FPGA进行硬件加速的门槛。
本文将研究一种面向Python的高层综合流程，
将Python编译到可综合于FPGA的Verilog代码，
提升Python计算的开发和计算效率。

\subsection{国内外研究现状}

近年来，针对高级语言的计算加速已经成为了研究的热点之一。
最常见的做法是软件层面的优化。
除此之外，硬件层面加速有高层综合技术和面向硬件设计的领域特定语言。
高层综合技术研究方向包括高层综合算法和优化、自动化设计工具、低功耗设计、混合编程模型以及应用领域拓展，
而硬件设计的领域特定语言相比高级语言提供了不同的抽象级别和编程范式，
二者的宗旨都是简化硬件设计流程并提高设计的抽象级别。

\subsubsection{软件层面的优化技术}

在需要依赖通用计算架构的场景下，
为了提高繁重运算任务的计算效率，
国内外研究人员在研究中发现编译器和通用计算架构中潜在的优化可能性，
提出了各种通用的优化技巧和方法，
也开发了成熟的优化工具，
广泛应用于学术界和工业界。

RPython\cite{rpython}是Python的一个精心设计的子集，
通过限制Python的动态特性到初始阶段，
禁止类和方法的定义在运行时动态调整，
使得类型可以被静态地确定下来，
减少了运行时的动态推断所带来的开销，
获得了执行效率的提升。

Cython\cite{cython}是一个优化静态编译器，
能够将Python语言和基于Pyrex的Cython扩展语言编译为C语言代码。
Cython也融合了C语言函数以及类型，
使得编译器生成的C语言代码可以非常高效地执行，
与此同时开发人员也可以在Python中利用成熟的C语言库。

PyPy\cite{pypy3}是CPython的替代品，
它基于RPython\cite{rpython}开发，
同时也反过来促进RPython的开发。
PyPy运行特定Python程序时非常快，
最高可以达到CPython的4.8倍速度，
主要受益于它的JIT编译器（Just-in-Time，在运行时编译的技术）\cite{jit}。
采用JIT的解释器会在实际运行代码之前编译，
通常是编译到字节码\cite{bytecode}级别，
真正的计算过程由于运行在字节码级别，
效率会有显著的提升。
由于JIT编译会占用一定的时间（通常称为预热），
这种技术主要促进长期运行的计算任务。
这篇文章\cite{pypy1}讲解了PyPy的跟踪式JIT编译器，
而这篇\cite{pypy2}则讲解了PyPy构建动态语言虚拟机的做法。

软件层面优化技术的不足之处在于无法突破通用计算架构的局限性，
无论编译器做到什么等级的优化，
通用计算架构的运行都需要基于指令，
通过CPU串行地进行计算；
虽然CPU可以通过多核实现并行，
但其并行度无法突破核心数，
并且添加核心的成本昂贵。
于是人们提出了各种异构计算架构，
最为广泛使用的异构计算架构便是FPGA，
其灵活性和计算性能受到广泛研究者的青睐，
但代价便是FPGA的开发门槛。

\subsubsection{硬件设计的领域特定语言}

为了应对传统FPGA开发需要的专业知识和低抽象层级，
国内外学者设计出一些领域特定语言（Domain Specific Language，DSL）缓解这种情况。
这些领域特定语言提供了更高抽象层次的硬件描述形式，
使得开发人员可以更多地思考设计的行为或算法本身，
而不需要处理硬件的细枝末节。
这种设计方式使得软件开发者参与硬件开发的学习成本大大降低，
因为领域特定语言的写法和软件设计语言非常相似。

这篇文章\cite{dsl1}提出了一种从DSL自动生成FPGA比特流的方法论，
通过解析DSL描述的应用中存在的并行性，
对应用实施优化，并识别出适用于该应用的系统架构，
以最大程度将用户从硬件级别的细节中解放出来。
作者在OptiML机器学习语言生成硬件系统的场景下进行了评估，
展现了这种方法的高生产力和高设计质量。

Halide\cite{halide}是一种图像处理领域的DSL，
他开创了将算法规范与实现调度分离以便于性能调优的先河。
后续的工作展示了如何将类似于Halide的语言编译成硬件。
Halide的调度表示优化策略，
如循环分块，这些优化不会影响算法的语义。

Bluespec\cite{bluespec}是一种使用受保护的原子操作实现组合硬件设计的硬件描述语言。
Bluespec编译器检测操作之间的冲突，
生成并行执行计划，
并在冲突时动态中止规则。

Spatial\cite{spatial}提供了从并行模式生成硬件的基本原语。
HeteroCL\cite{heterocl}是一个基于Python的DSL，
用于优化高于HLS抽象级别的程序。
这些语言抽象层次高，
并且不适合作为通用IR，
因为它们与特定的并行模型绑定在一起。

DSL在描述硬件上无可挑剔，
毕竟它们是针对硬件特性精心设计出来的，
同时保留了较高的抽象层级。
但这套设计模式仍然不能尽善尽美，
因为针对硬件设计出的DSL往往有着严格的基本语法，
或是令人费解的拓展语法，
可能会带来额外的思考负担。

\subsubsection{高层综合技术}

高层综合技术区别于硬件开发DSL之处在于采用了通用软件开发语言，
所以进一步省去了DSL的学习成本。
用高层综合设计硬件仅仅需要开发者编写软件语言代码，
编译器会自动生成行为一致的寄存器传输级（Register-Transfer Level, RTL）硬件结构，
不仅提升了开发效率，
也做到了高效率的设计空间探索。

ScaleHLS\cite{scalehls}是基于一种多层次编译器架构MLIR\cite{mlir}的可拓展和自定义的高层综合框架，
它在多个层次表示HLS设计，
通过应用专用的HLS分析和转换库，
将优化问题在各自最合适的层级解决。

除了作为程序开发语言的DSL，
另一类硬件描述DSL即IR通常用于高层综合编译器内部实现。
IR是一种介于源代码和目标代码之间的抽象表示形式，
通常用于在编译器的不同阶段之间传递信息，
并且可以在优化、代码生成等过程中进行分析和转换。

IR是HLS编译器领域的研究热点，
许多硬件生成器复用了诸如LLVM、GCC的内部IR和SUIF等软件IR。
一些HLS编译器包括IR，可以扩展其顺序输入语言以表示并行性。
\mu IR\cite{muir}使用任务并行表示，
SPARK\cite{spark}针对推测和并行性优化，
CIRRF\cite{cirrf}提供了流水线的原语。
另一类HLS IR使用有限状态机（FSM）来建模程序在周期级别上的执行计划。
这些IR对FSM内部操作的时序行为施加了限制。

然而，目前的研究中鲜有为C/C++之外的高级语言设计的HLS编译器，
与动态类型语言相关的工作少之又少，
主要原因是从抽象层级较高的表示推断出硬件描述信息需要克服种种困难，
并且目前大多数高级语言开发者并不接触硬件设计，
连接高级语言与硬件设计意义重大。

\subsection{主要研究内容}

本工作研究了将一种Python代码生成动态类型Verilog HDL的高层综合流程，
能够将描述硬件的Python代码编译为Verilog代码，
进而用于FPGA硬件加速。
该高层综合流程包括Python代码的前端分析、IR生成、类型展开、优化和代码生成，
其中前端分析器会对Python代码的动态类型进行提前分析，
确定可能出现的类型，并由IR生成器生成XLS IR作为中间代码；
类型展开PASS会在XLS优化器上进行，
对于前端生成的IR进行类型展开，
初步生成硬件上的动态类型描述；
最后再由XLS的其他PASS对IR进行优化，
并生成目标Verilog代码。
生成的Verilog代码保留了用户配置的类型范围下的动态类型，
能够在计算过程中判断值的类型，
选择不同的数据通路完成计算。

用Python开发硬件能够显著降低了硬件开发的门槛，
结合了硬件计算的高效率和Python的简洁性，
使得开发人员无需关注许多算法逻辑的实现细节，
提供更高层次的抽象级别，
使开发人员专注于算法的实现逻辑，
而将硬件逻辑的底层实现交给编译器完成。

面向FPGA（现场可编程门阵列）的Python编译技术是指使用Python语言来描述和设计FPGA电路，
并将其编译成适用于FPGA的硬件描述语言（HDL）或比特流文件的过程。
这种方法的主要优点是使用了Python的高级抽象能力和灵活性，
使得硬件设计变得更加易于理解、快速迭代和自动化。

\subsection{论文结构安排}

本文的章节划分和主要内容如下：

第一章为绪论，介绍了本设计的研究背景，
罗列了现有的面向高级语言的计算加速措施，
从计算性能、开发效率、表达能力等角度分析了现有的硬件设计流程的优缺点，
以说明本次工作的研究意义，
并简要概括了本文的主要研究内容。

第二章介绍本次研究所需的背景知识，
介绍语言设计、编译器架构设计、中间表示、硬件描述等基础理论，
讨论不同技术选型的优缺点，
在此基础上介绍本次研究技术方案的相关知识。

第三章为系统设计，
介绍本文提出的Python到Verilog RTL的高层综合编译器的系统架构，
再深入介绍整个编译器的前端部分、XLS中间表示优化和转换部分。
前端部分主要介绍类型推导方式，以及XLS中间表示的结构的生成；
而XLS中间表示优化和转换部分阐述基于模板展开的设计方法。
本文也为XLS添加了浮点数支持的解决方案，
所以在此章后半部分介绍了浮点数的XLS中间表示模板和运算单元的展开方式。

第四章为系统测试，
介绍了本工作的测试设计方案，
用以测试整个编译器各模块的正确性以及性能。
该部分首先介绍测试的设计原则以及基线，
然后介绍了测试工作的设计方法。
最后介绍了相比于基线，
本系统所带来的性能提升。